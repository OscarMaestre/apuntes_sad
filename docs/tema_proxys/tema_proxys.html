

<!DOCTYPE html>
<html class="writer-html5" lang="es" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Instalación y configuración de servidores proxy &mdash; documentación de Apuntes de Seguridad y alta disponibilidad - 1.0</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="../genindex.html" />
    <link rel="search" title="Búsqueda" href="../search.html" />
    <link rel="next" title="Legislación y normas sobre seguridad" href="../tema_lopd/tema_lopd.html" />
    <link rel="prev" title="Implantación de soluciones de alta disponibilidad" href="../tema_sad/tema_sad.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Inicio de Documentación"> Apuntes de Seguridad y alta disponibilidad
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contenidos:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tema_pautas_seguridad_informatica/tema_pautas_seguridad_informatica.html">Adopción de pautas de seguridad informática</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_cortafuegos/tema_cortafuegos.html">Instalación y configuración de cortafuegos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_sad/tema_sad.html">Implantación de soluciones de alta disponibilidad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_sad/tema_sad.html#ejercicio-recuperando-una-web-con-vagrant">Ejercicio: recuperando una web con Vagrant</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Instalación y configuración de servidores  proxy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#material-para-la-unidad">Material para la unidad</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tipos-de-proxy-caracteristicas-y-funciones">Tipos de  proxy . Características y funciones.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tipos-de-proxy-en-funcion-de-la-arquitectura-de-red">Tipos de proxy en función de la arquitectura de red.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tipos-de-proxy-en-funcion-de-la-aplicacion">Tipos de proxy en función de la aplicación</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#instalacion-y-configuracion-de-clientes-proxy">Instalación y configuración de clientes proxy.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instalacion-de-servidores-proxy">Instalación de servidores proxy.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ficheros-de-interes">Ficheros de interés</a></li>
<li class="toctree-l3"><a class="reference internal" href="#iniciando-y-parando-el-servicio">Iniciando y parando el servicio</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acls-en-squid-acls-de-origen">ACLs en Squid. ACLS de origen.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuracion-de-filtros">Configuración de filtros.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#acls-en-squid-acls-de-destino">ACLs en Squid. ACLS de destino.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acls-basadas-en-la-url">ACLs basadas en la URL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acls-basadas-en-la-ruta">ACLs basadas en la ruta</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acls-basadas-en-el-tipo-de-archivo">ACLs basadas en el tipo de archivo</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#metodos-de-autenticacion-en-un-proxy">Métodos de autenticación en un  proxy .</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuracion-del-almacenamiento-en-la-cache-de-un-proxy">Configuración del almacenamiento en la caché de un proxy .</a></li>
<li class="toctree-l2"><a class="reference internal" href="#proxys-inversos">Proxys  inversos.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#proxys-encadenados">Proxys  encadenados.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pruebas-de-funcionamiento-herramientas-graficas">Pruebas de funcionamiento. Herramientas gráficas.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tema_lopd/tema_lopd.html">Legislación y normas sobre seguridad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_acceso_remoto/tema_acceso_remoto.html">Implantación de técnicas de acceso remoto. Seguridad perimetral</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apuntes de Seguridad y alta disponibilidad</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Instalación y configuración de servidores  proxy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tema_proxys/tema_proxys.rst.txt" rel="nofollow"> Ver código fuente de la página</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="instalacion-y-configuracion-de-servidores-proxy">
<h1>Instalación y configuración de servidores  proxy<a class="headerlink" href="#instalacion-y-configuracion-de-servidores-proxy" title="Enlazar permanentemente con este título">¶</a></h1>
<div class="section" id="material-para-la-unidad">
<h2>Material para la unidad<a class="headerlink" href="#material-para-la-unidad" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para esta unidad vas a necesitar dos máquinas virtuales.</p>
<ul class="simple">
<li><p>Una de las máquinas virtuales ejecutará Ubuntu 20 para escritorio y tendrá una tarjeta de red en modo puente. Si quieres puedes construir una con rapidez yendo a un directorio vacío y ejecutando los comandos <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">init</span> <span class="pre">oscarmaestre/ubuntu20desktop</span></code> y despues <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">up</span></code>. No olvides añadir una segunda tarjeta en modo puente.</p></li>
<li><p>La otra máquina virtual usará Ubuntu Server 20. Puedes construir una con <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">init</span> <span class="pre">oscarmaestre/ubuntuserver20</span></code> y con <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">up</span></code>. No olvides añadir una segunda tarjeta en modo puente.</p></li>
</ul>
<p>Habrá que configurar la IP en ambos casos y recuerda que es <strong>imprescindible</strong> que ambas máquinas puedan hacerse ping.</p>
</div>
<div class="section" id="tipos-de-proxy-caracteristicas-y-funciones">
<h2>Tipos de  proxy . Características y funciones.<a class="headerlink" href="#tipos-de-proxy-caracteristicas-y-funciones" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Antes de explicar los tipos de proxy es importante entender el concepto: básicamente, se puede decir que un proxy es un software que actúa como intermediario entre las peticiones de un cliente y un servidor. Si examinamos la figura siguiente veremos que ahora no hay solo una petición y una respuesta,sino que hay varios pasos más.</p>
<div class="figure align-default" id="id1">
<a class="reference internal image-reference" href="../_images/comportamiento_proxy.png"><img alt="Ejemplos de permisos" src="../_images/comportamiento_proxy.png" style="width: 331.5px; height: 187.0px;" /></a>
<p class="caption"><span class="caption-text">Comportamiento de un proxy</span><a class="headerlink" href="#id1" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<ol class="arabic simple">
<li><p>Un cliente solicita, por ejemplo, una web como <a class="reference external" href="http://acme.com">http://acme.com</a></p></li>
<li><p>La petición pasa primero por el proxy, que la intercepta, la analiza y puede tomar decisiones sobre si permitirla o no. Si está permitida <strong>es el proxy quien realiza la petición en el nombre del usuario</strong></p></li>
<li><p>El servidor contesta a la petición y dicha respuesta llega al proxy, quien a menudo conservará la respuesta en caché por si en el futuro alguien necesita la misma página web.</p></li>
<li><p>La respuesta finalmente llega al cliente.</p></li>
</ol>
<p>Una ventaja añadida de este caso del proxy es que si en el futuro otra máquina de la red necesita la misma web obtendrá la misma página pero a más velocidad, al no ser necesario hacer una conexión extra al exterior.</p>
<p>Una vez analizado el concepto de proxy se pueden encontrar distintos tipos de proxy</p>
<div class="section" id="tipos-de-proxy-en-funcion-de-la-arquitectura-de-red">
<h3>Tipos de proxy en función de la arquitectura de red.<a class="headerlink" href="#tipos-de-proxy-en-funcion-de-la-arquitectura-de-red" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Podemos distinguir entre proxy directo (o simplemente proxy), proxy abierto y proxy inverso.</p>
<p>El término proxy suele reservarse para esta arquitectura de red. En este caso, el proxy está dentro de nuestra red y nosotros como administradores tenemos el control y podemos tomar todas las decisiones que deseemos.</p>
<div class="figure align-default" id="id2">
<a class="reference internal image-reference" href="../_images/proxy.png"><img alt="Proxy directo" src="../_images/proxy.png" style="width: 296.79999999999995px; height: 129.5px;" /></a>
<p class="caption"><span class="caption-text">Proxy (en su configuración más típica)</span><a class="headerlink" href="#id2" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>En un proxy abierto el proxy no está bajo nuestro control, sino que está en alguna red intermedia y suele ofrecer servicios como ocultación de ip, privacidad y similares. No tenemos garantías de que realmente el proxy no registre nuestra actividad.</p>
<div class="figure align-default" id="id3">
<a class="reference internal image-reference" href="../_images/proxy_abierto.png"><img alt="Un proxy abierto" src="../_images/proxy_abierto.png" style="width: 324.79999999999995px; height: 110.6px;" /></a>
<p class="caption"><span class="caption-text">Proxy abierto</span><a class="headerlink" href="#id3" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>Un proxy inverso es aquel que se sitúa dentro de la red del servidor de manera que actúa como caché, distribuidor de carga o simplemente como respaldo.</p>
<div class="figure align-default" id="id4">
<a class="reference internal image-reference" href="../_images/proxy_inverso.png"><img alt="Ejemplos de proxy inverso" src="../_images/proxy_inverso.png" style="width: 308.0px; height: 110.6px;" /></a>
<p class="caption"><span class="caption-text">Proxy inverso</span><a class="headerlink" href="#id4" title="Enlace permanente a esta imagen">¶</a></p>
</div>
</div>
<div class="section" id="tipos-de-proxy-en-funcion-de-la-aplicacion">
<h3>Tipos de proxy en función de la aplicación<a class="headerlink" href="#tipos-de-proxy-en-funcion-de-la-aplicacion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Aunque mucho menos conocidos que los proxies web existen proxys para otras aplicaciones como FTP e IRC. En este módulo no se tratan estos programas aunque su funcionamiento en esencia es muy similar a los proxies web.</p>
<p>Un tipo de proxy muy habitual fuera de HTTP es el proxy SOCKS. Estos proxies <em>trabajan a nivel de TCP</em> y no en la capa de aplicación. La versión 5 de SOCKS (llamada SOCKS5) permite incluso autenticación a nivel de TCP.</p>
<p>ICAP es otro protocolo para proxies que permite trabajar de varias maneras:</p>
<ul class="simple">
<li><p>Modo solicitud: el proxy redirige la petición y si los filtros lo permiten redirige la petición hacia el servidor. Esto lo hace útil para <strong>filtra conexiones</strong></p></li>
<li><p>Modo de respuesta: en este modo la petición se redirige y cuando llega la respuesta podemos procesarla con filtros y decidir qué hacer con el contenido que llega. Esto permite <strong>filtrar contenidos</strong></p></li>
</ul>
<p>En el resto del tema veremos como configurar SQUID, un proxy muy sofisticado con capacidad de procesar tráfico HTTP y FTP y capaz de actuar tanto en modo solicitud como en modo respuesta.</p>
</div>
</div>
<div class="section" id="instalacion-y-configuracion-de-clientes-proxy">
<h2>Instalación y configuración de clientes proxy.<a class="headerlink" href="#instalacion-y-configuracion-de-clientes-proxy" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Configurar un cliente para que utilice un proxy es bastante sencillo. En la imagen siguiente se muestra una captura de Firefox en el que se indica que la conexión debe hacerse a través de un proxy. Como puede apreciarse basta con rellenar la IP del servidor proxy y el puerto en el que escucha (Squid suele hacerlo en el 3128).</p>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="../_images/Proxy_en_firefox.jpg"><img alt="Configuración de proxies en Firefox" src="../_images/Proxy_en_firefox.jpg" style="width: 453.5px; height: 290.0px;" /></a>
<p class="caption"><span class="caption-text">Configuración de proxies en Firefox</span><a class="headerlink" href="#id5" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>Sin embargo, aunque hayamos instalado Squid en la segunda máquina virtual veremos que el Firefox de la máquina cliente no funciona y muestra un mensaje como «El servidor proxy está rechazando las conexiones entrantes». Aún se tiene que configurar el servidor, cosa que haremos en los pasos siguientes.</p>
</div>
<div class="section" id="instalacion-de-servidores-proxy">
<h2>Instalación de servidores proxy.<a class="headerlink" href="#instalacion-de-servidores-proxy" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Squid permite descargarse el código fuente y recompilarlo usando la secuencia típica de comandos en GNU/Linux:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">configure</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code></p></li>
</ol>
<p>Ofrece más eficiencia, al adaptar el programa a la máquina donde lo vamos a ejecutar. Sin embargo, dado que compilar es un proceso lento, en clase usaremos el comando típico <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">squid</span></code>, que instalará el programa y todas sus dependencias.</p>
<div class="section" id="ficheros-de-interes">
<h3>Ficheros de interés<a class="headerlink" href="#ficheros-de-interes" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>El fichero <code class="docutils literal notranslate"><span class="pre">/etc/squid/squid.conf</span></code> contiene la configuración del proxy, se hablará detenidamente de él en seguida. Este fichero acepta procesar otros ficheros de configuración que estén en el directorio <code class="docutils literal notranslate"><span class="pre">/etc/squid/conf.d</span></code>. Por tanto, <strong>no es necesario meterlo todo siempre dentro del mismo fichero.</strong> Esto permite trabajar más organizadamente, ya que como podrá apreciarse pronto, el fichero <code class="docutils literal notranslate"><span class="pre">squid.conf</span></code> es muy grande y localizar ciertos parámetros puede ser difícil.</p></li>
<li><p>El directorio <code class="docutils literal notranslate"><span class="pre">/var/spool/squid</span></code> contiene los directorios que actuarán como caché de Squid.</p></li>
</ul>
</div>
<div class="section" id="iniciando-y-parando-el-servicio">
<h3>Iniciando y parando el servicio<a class="headerlink" href="#iniciando-y-parando-el-servicio" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Se puede arrancar Squid usando <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">squid</span> <span class="pre">start</span></code>, detenerlo con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">squid</span> <span class="pre">stop</span></code> y hacer un reinicio del servicio con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">squid</span> <span class="pre">restart</span></code>. Sin embargo, antes de arrancar puede ser útil ejecutar <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">squid</span> <span class="pre">-k</span> <span class="pre">parse</span></code>, que analizará el fichero de configuración y nos dirá si hay algún fallo en alguna línea.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Squid siempre muestra mucha información durante el análisis, así que puede ser interesante ejecutar algo como <code class="docutils literal notranslate"><span class="pre">squid</span> <span class="pre">-k</span> <span class="pre">parse</span> <span class="pre">2&gt;</span> <span class="pre">errores.txt</span></code> para poder leer los resultados tranquilamente con algo como <code class="docutils literal notranslate"><span class="pre">nano</span> <span class="pre">errores.txt</span></code>. Si se prueba a introducir un error veremos como el fichero muestra no solo el error, sino también todo lo que funciona (lo que complica el localizar el error)</p>
</div>
<ul class="simple">
<li><p>Si hacemos un cambio en la configuración y deseamos que Squid tome la nueva configuración <em>sin reiniciar el servicio</em> se puede usar <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">squid</span> <span class="pre">-k</span> <span class="pre">reconfigure</span></code>.</p></li>
</ul>
</div>
<div class="section" id="acls-en-squid-acls-de-origen">
<h3>ACLs en Squid. ACLS de origen.<a class="headerlink" href="#acls-en-squid-acls-de-origen" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Squid <em>no permite su uso a cualquier cliente.</em> Puede usar listas de control de acceso para determinar exactamente lo que se quiere hacer:</p>
<ul class="simple">
<li><p>Se puede restringir el uso a solo ciertas IPs origen.</p></li>
<li><p>Se puede restrigir el acceso a determinados sitios web destino.</p></li>
<li><p>Se pueden combinar ambos mecanismos para permitir el acceso solo a ciertas web y solo por parte de ciertos usuarios de la empresa.</p></li>
</ul>
<p>Por defecto <strong>Squid no permite a nadie la conexión.</strong> Así que es necesario crear una ACL donde indiquemos una lista de máquinas y despues tendremos que dar permiso a esa lista de máquinas.</p>
<p>Como hemos dicho antes, no es necesario meter todo en el fichero <code class="docutils literal notranslate"><span class="pre">/etc/squid.conf</span></code>, así que vamos a definir nuestro propio acceso en un fichero como <code class="docutils literal notranslate"><span class="pre">/etc/squid/conf.d/accesopropio.acl</span></code>. Supongamos que la red de nuestra empresa tiene el prefijo 192.168.1.0/24…</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl red_empresa src <span class="m">192</span>.168.1.0/24
http_access allow red_empresa
</pre></div>
</div>
<p>Si ponemos esto en el fichero <code class="docutils literal notranslate"><span class="pre">/etc/squid/conf.d/accesopropio.acl</span></code> y ejecutamos <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">squid</span> <span class="pre">-k</span> <span class="pre">parse</span></code> podremos ver si hay algún error. Si lo hay lo corregiremos y si no podremos ejecutar <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">squid</span> <span class="pre">restart</span></code> para que el proxy empiece a funcionar. Si nos vamos a la máquina cliente y probamos alguna URL veremos que ahora sí estamos navegando a través del proxy. Si se desea comprobar si realmente navegamos a través del proxy podemos detener el proxy en el servidor con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">squid</span> <span class="pre">stop</span></code> y ver que Firefox deja de funcionar. Por supuesto, si reiniciamos el proxy Firefox volverá a poder navegar con normalidad.</p>
</div>
</div>
<div class="section" id="configuracion-de-filtros">
<h2>Configuración de filtros.<a class="headerlink" href="#configuracion-de-filtros" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="section" id="acls-en-squid-acls-de-destino">
<h3>ACLs en Squid. ACLS de destino.<a class="headerlink" href="#acls-en-squid-acls-de-destino" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Una vez que hemos visto como procesar las IPs de origen que pueden navegar nos interesan otros parámetros de Squid como las listas <code class="docutils literal notranslate"><span class="pre">dstdomain.</span></code> Estas listas permiten tomar decisiones sobre dominios de destino por los cuales quieren navegar los clientes (y normalmente querremos saberlo para denegarles el permiso). Supongamos que hay un dominio llamado <code class="docutils literal notranslate"><span class="pre">http://marca.com</span></code> al cual deseamos prohibir el acceso. Podemos poner un fichero como <code class="docutils literal notranslate"><span class="pre">/etc/squid/conf.d/accesopropio.acl</span></code> en el que escribamos</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl prohibidos dstdomain .marca.com
http_access deny prohibidos
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>El orden de las ACLS es <strong>importantísimo</strong>. Si en el apartado anterior habíamos dado permiso a ciertos usuarios ese «permiso para salir» ya fue concedido así que intentar denegar no funcionará.</p>
</div>
<p>Este fichero <strong>no deniega el acceso al periódico</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl red_empresa src <span class="m">192</span>.168.1.0/24
http_access allow red_empresa
acl prohibidos dstdomain .marca.com
http_access deny prohibidos
</pre></div>
</div>
<p>Este fichero <strong>sí deniega el acceso al periódico</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl prohibidos dstdomain .marca.com
http_access deny prohibidos
acl red_empresa src <span class="m">192</span>.168.1.0/24
http_access allow red_empresa
</pre></div>
</div>
<p>En el caso de las restricciones a sitios web es frecuente que haya varios, así que un fichero podría ser algo así:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl prohibidos dstdomain .marca.com .sport.es
http_access deny prohibidos
acl red_empresa src <span class="m">192</span>.168.1.0/24
http_access allow red_empresa
</pre></div>
</div>
<p>Pero es habitual tener muchos nombres de dominio. Para simplificar esto, Squid permite cargar datos desde ficheros externos usando las comillas. Por ejemplo, supongamos que queremos tener todos los dominios prohibidos en un fichero llamado por ejemplo «/etc/squid/sitios_prohibidos.txt». Podemos usar este fichero:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl prohibidos dstdomain <span class="s2">&quot;/etc/squid/sitios_prohibidos.txt&quot;</span>
http_access deny prohibidos
acl red_empresa src <span class="m">192</span>.168.1.0/24
http_access allow red_empresa
</pre></div>
</div>
<p>Y por supuesto poner en el fichero <code class="docutils literal notranslate"><span class="pre">/etc/sitios_prohibidos.txt</span></code> una lista de dominios no permitidos, como:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.marca.com
.sport.es
.mundodeportivo.com
...
</pre></div>
</div>
<p>En general, se pueden usar las comillas en todas las listas de acceso. Si Squid encuentra algo entre comillas, asumirá que es la ruta de un fichero y que debe tomar todas las líneas de dicho fichero.</p>
</div>
<div class="section" id="acls-basadas-en-la-url">
<h3>ACLs basadas en la URL<a class="headerlink" href="#acls-basadas-en-la-url" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A veces no es suficiente con fabricar una lista de páginas web prohibidas porque simplemente puede haber demasiadas. En esos casos se pueden usar ACLs que examinan el nombre de dominio de la web y si dicho nombre se ajusta una regla entonces denegarlo.</p>
<p>Por ejemplo, supongamos que hay una serie de páginas que se desea prohibir como <code class="docutils literal notranslate"><span class="pre">http://violencia.com</span></code> , <code class="docutils literal notranslate"><span class="pre">http://violencia.net</span></code> , <code class="docutils literal notranslate"><span class="pre">http://masviolencia.com</span></code> , <code class="docutils literal notranslate"><span class="pre">http://todoviolencia.com</span></code> , <code class="docutils literal notranslate"><span class="pre">http://muchaviolencia.es</span></code> , etc… Como vemos, la lista de páginas podría ser enorme. En ese caso, podemos usar una regla como esta:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl prohibicion_violencia url_regex violen
http_access deny prohibicion_violencia
</pre></div>
</div>
<p>Así, todas página que tengan un nombre de dominio que incluya de alguna manera la cadena «violen» serán denegadas.</p>
</div>
<div class="section" id="acls-basadas-en-la-ruta">
<h3>ACLs basadas en la ruta<a class="headerlink" href="#acls-basadas-en-la-ruta" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Si el sistema anterior no es suficiente se puede utilizar el análisis de las rutas. Por ejemplo, si examinamos una página como <code class="docutils literal notranslate"><span class="pre">http://acme.com/violencia</span></code> veremos que claramente contiene un término que deseamos prohibir. Para prohibir páginas Web en las que ocurra esto se pueden usar las ACLs basadas en ruta de esta manera:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl prohibicion_ruta_violencia urlpath_regex violen
http_access prohibicion_ruta_violencia deny
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Hoy en día cada vez más páginas, incluidos los buscadores usan cifrado en las conexiones. Eso significa que estos bloqueos podrían no funcionar ya que lo primero que hace el navegador es establecer una conexión cifrada (que Squid no puede descifrar) y despues solicitar la página concreta</p>
</div>
</div>
<div class="section" id="acls-basadas-en-el-tipo-de-archivo">
<h3>ACLs basadas en el tipo de archivo<a class="headerlink" href="#acls-basadas-en-el-tipo-de-archivo" title="Enlazar permanentemente con este título">¶</a></h3>
<p>En Internet hay una definición general de tipos de archivo llamada «tipos MIME» (Multimedia Internet Mail Extensions, se definieron para transportar archivos en el correo electrónico). Si lo que nos interesa en bloquear el acceso a ciertos tipos de contenido como vídeo o audio podemos bloquear usando el análisis del tipo de petición MIME al servidor de esta manera. En este caso bloqueamos los «webm» que es un tipo de vídeo muy utilizado, aunque no el único (de hecho YouTube ofrece diversos tipos):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>acl bloquear_video req_mime_type video/webm
http_access deny bloquear_video
</pre></div>
</div>
</div>
</div>
<div class="section" id="metodos-de-autenticacion-en-un-proxy">
<h2>Métodos de autenticación en un  proxy .<a class="headerlink" href="#metodos-de-autenticacion-en-un-proxy" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Aparte de usar direcciones IP podemos hacer que un proxy exija a un usuario el proporcionar un usuario  y contraseña si desea navegar por Internet. Existen diversos como mecanismos como NTLM (que usar autenticación Windows) o LDAP (que usa un servidor LDAP). Dado que estamos usando Unix y que en este módulo no se menciona LDAP usaremos el mecanismo NCSA que usará un fichero de usuarios y claves externo gestionado por una herramienta externa, en concreto usaremos la herramienta <code class="docutils literal notranslate"><span class="pre">httpasswd</span></code> (si no la tenemos habrá que instalarla con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">apache2-utils</span></code></p>
<p>Una vez la tengamos instalada tenemos que decidir donde ubicar el fichero de credenciales, que por supuesto debe ser un lugar protegido de los usuarios normales. Elegiremos <code class="docutils literal notranslate"><span class="pre">/etc/squid/credenciales</span></code> y empezaremos insertando un usuario llamado «contabilidad» de esta manera: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">htpasswd</span> <span class="pre">-c</span> <span class="pre">/etc/squid/credenciales</span> <span class="pre">contabilidad</span></code>. La herramienta nos pedirá que indiquemos la clave de este usuario.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>La opcion <code class="docutils literal notranslate"><span class="pre">-c</span></code> es para <em>crear el fichero</em>, así que solo la usaremos una vez.</p>
</div>
<p>A continuación crearemos por ejemplo otro usuario llamado «gerencia» con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">htpasswd</span> <span class="pre">/etc/squid/credenciales</span> <span class="pre">gerencia</span></code> . En este punto ya tenemos un fichero con dos usuarios. Puede mostrarse el contenido de este fichero con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cat</span> <span class="pre">/etc/squid/credenciales</span></code> y veremos que aparecen los usuarios y su clave cifrada.</p>
<p>Una vez hecho esto debemos configurar la autenticación de Squid usando estos parámetros:</p>
<ol class="arabic simple">
<li><p>«program»: se usa un módulo de Squid llamado <code class="docutils literal notranslate"><span class="pre">ncsa_auth</span></code> que debería estar dentro de <code class="docutils literal notranslate"><span class="pre">/usr/lib/squid3</span></code> probablemente con la ruta <code class="docutils literal notranslate"><span class="pre">/usr/lib/squid3/basic_ncsa_auth</span></code> .</p></li>
<li><p>«children»: indica el número de módulos hijo que deben estar listos para atender peticiones de autenticación. Este valor dependerá de cuantas personas como máximo se vayan a conectar al proxy. Para nuestro ejemplo un valor de 10 será suficiente.</p></li>
<li><p>«realm»: un texto que aparecerá a los usuarios que inicien sesión.</p></li>
<li><p>«credentialsttl»: tiempo máximo que se almacena la sesión de alguien antes de volver a pedirle la clave.</p></li>
</ol>
<p>Así, si queremos crear una lista en la que estén los usuarios autenticados podríamos configurar y crear todo con algo como esto:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#Esto indica que para un esquema de configuración de nivel básico</span>
<span class="c1">#usaremos el programa basic_ncsa_auth con el fichero de credenciales</span>
<span class="c1">#/etc/squid/credenciales</span>
auth_param basic program /usr/lib/squid3/basic_ncsa_auth /etc/squid/credenciales

<span class="c1">#Se deben poder autenticar hasta a 10 usuarios a la vez</span>
auth_param basic children <span class="m">10</span>

<span class="c1">#Texto que se envía a los usuarios que inicien sesión</span>
auth_param basic realm Indique sus credenciales

auth_param basic credentialsttl <span class="m">2</span> hours

<span class="c1">#Esto fabrica una lista para indicar &quot;usuarios que están autenticados&quot;.</span>
acl autenticados proxy_auth REQUIRED

<span class="c1">#Esto indica la lista de periodicos deportivos</span>
acl deportes dstdomain .marca.com

<span class="c1">#Y aqui está la clave, COMBINAR listas</span>
<span class="c1">#Se deniega el acceso al periodico a</span>
<span class="c1">#aquellos usuarios que NO estén autenticados</span>
http_access deny deportes !autenticados
</pre></div>
</div>
</div>
<div class="section" id="configuracion-del-almacenamiento-en-la-cache-de-un-proxy">
<h2>Configuración del almacenamiento en la caché de un proxy .<a class="headerlink" href="#configuracion-del-almacenamiento-en-la-cache-de-un-proxy" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En general los valores por defecto de Squid suelen considerarse bastante apropiados, pero pueden modificarse algunos de ellos si se desea obtener más rendimiento.</p>
<p>..code-block:: bash</p>
<blockquote>
<div><p>cache_dir ufs /var/spool/squid 20000 64 1024</p>
</div></blockquote>
<p>Esta caché acepta hasta 20.000MB de datos organizándonos en 64 directorios de hasta 1024 subdirectorios cada uno</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cache_mem 16MB
</pre></div>
</div>
<p>Indica que se deben tener preparados unos 16MB de RAM para los objetos populares en cache (páginas o archivos muy solicitados).</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Hay que tener cuidado con cuanta memoria RAM consume Squid ya que si tenemos muy poca la caché empezará a desviar objetos a «swap» y el rendimiento bajará en picado. En general la <code class="docutils literal notranslate"><span class="pre">cache_mem</span></code> debe ser como un tercio de la RAM disponible y luego añadir unos 14MB por cada GB de caché en disco. Esto significa que si en nuestro ejemplo tenemos 20GB de caché en disco y una <code class="docutils literal notranslate"><span class="pre">cache_mem</span></code> de 16MB debemos asegurarnos de tener como minimo (16*3)+(20*14)=48+280=328MB como minimo de RAM.</p>
</div>
<p>Squid rota los ficheros de caché automáticamente y borra los ficheros menos usados para dar cabida a los nuevos. Si de todas maneras se desea saber cuanto espacio está ocupando la cache puede usarse el comando <code class="docutils literal notranslate"><span class="pre">du</span> <span class="pre">-h</span> <span class="pre">/var/spool/squid</span></code> para ver cuanto espacio en disco ocupa la caché.</p>
</div>
<div class="section" id="proxys-inversos">
<h2>Proxys  inversos.<a class="headerlink" href="#proxys-inversos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Como ya hemos visto antes, un proxy inverso es aquel que se sitúa delante de un servidor Web con el objetivo de «descargarle de trabajo», como señala la figura siguiente:</p>
<div class="figure align-default" id="id6">
<a class="reference internal image-reference" href="../_images/proxy_inverso.png"><img alt="Ejemplos de proxy inverso" src="../_images/proxy_inverso.png" style="width: 308.0px; height: 110.6px;" /></a>
<p class="caption"><span class="caption-text">Proxy inverso</span><a class="headerlink" href="#id6" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>Para experimentar con esta configuración necesitaremos esto:</p>
<ul class="simple">
<li><p>Dos máquinas virtuales, ambas con Ubuntu Server.</p></li>
<li><p>En una de ellas (que llamaremos «Proxy») pondremos el proxy Squid (si no se tiene, se debe instalar con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">squid</span></code></p></li>
<li><p>En la otra (que llamaremos «Servidor Web») pondremos el servidor Web Apache, PHP y Links (se puede instalar con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">apache2</span> <span class="pre">php</span></code> ). Asegúrate de que tenga una carpeta compartida con el anfitrión para que podamos pasar con comodidad ficheros entre ambas máquinas.</p></li>
<li><p>Las dos máquinas deben tener una tarjeta de red en modo puente, deben tener un IP de la misma red y deben poder hacerse ping entre ellas.</p></li>
</ul>
<p>Dentro del servidor Web pondremos una pequeña página PHP que simplemente muestre información de la fecha y hora, como esta. La llamaremos <code class="docutils literal notranslate"><span class="pre">index.php</span></code> y debe estar en el directorio <code class="docutils literal notranslate"><span class="pre">/var/www/html</span></code> (asegúrate también de que la página la puede leer todo el mundo con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">chmod</span> <span class="pre">a+r</span> <span class="pre">/var/www/html/index.php</span></code> :</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html&gt;</span>
<span class="x">  </span>
<span class="x">  &lt;head&gt;</span>
<span class="x">    &lt;title&gt;Página HTML para Servidor web con proxy inverso&lt;/title&gt;</span>
<span class="x">    &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="x">  &lt;/head&gt;</span>
<span class="x">  &lt;!--Cuerpo--&gt;</span>
<span class="x">  &lt;body&gt;</span>
<span class="x">  &lt;h1&gt;Bienvenido a nuestra página&lt;/h1&gt;</span>
<span class="x">  &lt;p&gt;</span>
<span class="x">    </span><span class="cp">&lt;?php</span>

    <span class="nv">$fecha</span><span class="o">=</span><span class="nb">date</span><span class="p">(</span><span class="s2">&quot;d/m/Y&quot;</span><span class="p">);</span>
    <span class="nv">$hora</span> <span class="o">=</span><span class="nb">date</span><span class="p">(</span><span class="s2">&quot;h:i:s&quot;</span><span class="p">);</span>

    <span class="k">echo</span> <span class="s2">&quot;Esta página se generó en el servidor el </span><span class="si">$fecha</span><span class="s2"> a las </span><span class="si">$hora</span><span class="s2">.&quot;</span><span class="p">;</span>
    <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">  &lt;/p&gt;</span>
<span class="x">  &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
<p>Si está todo bien, en el Servidor Web podremos ejecutar <code class="docutils literal notranslate"><span class="pre">links</span> <span class="pre">http://127.0.0.1</span></code> y veremos la página generada en el servidor donde nos dirá la fecha y la hora.</p>
<p>Una vez configurado el Servidor Web toca configurar Squid. En Squid un «proxy inverso» se denomina un «acelerador». En realidad, la configuración básica es muy sencilla y aun así ya ofrece mucha mejora en el rendimiento:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>http_port <span class="m">80</span> accel <span class="nv">defaultsite</span><span class="o">=</span><span class="m">192</span>.168.1.130 no-vhost
cache_peer <span class="m">192</span>.168.1.30 parent <span class="m">80</span> <span class="m">0</span> no-query originserver <span class="nv">name</span><span class="o">=</span>AceleradorWebLocal
refresh_pattern <span class="nv">$php</span> <span class="m">2</span> <span class="m">50</span>% <span class="m">9</span>
</pre></div>
</div>
<p>¿Qué significa todo esto?</p>
<ul class="simple">
<li><p>La primera línea indica que Squid va aceptar peticiones en el puerto 80 pero esto va a servir para acelerar un sitio web en el que no hay hosting virtual.</p></li>
<li><p>La segunda línea indica que vamos a cachear tales peticiones conectando con el sitio web principal («parent) y que cuando se conecten a nuestro puerto 80 no nos conectaremos a ningún otro puerto ICP (sirve para proxies encadenados), y que como no haremos encadenamiento de proxies no hay que hacer consultas («no-query») sino que esto es el servidor real de origen («originserver»). A este servidor cacheado le hemos puesto un nombre que luego podríamos proteger con ACLs.</p></li>
<li><p>La tercera línea indica que cualquier petición que termine en PHP debe ser cacheada durante al menos 2 minutos y como máximo 9 minutos. Si alguna petición <em>no lleva indicado el tiempo máximo por parte del navegador</em> se asume que se conserva en caché hasta que llega a la mitad de su edad. Por ejemplo si alguien pidió un PHP hace 6 horas y han pasado 3 se considera que el objeto ya no debe estar en caché.</p></li>
</ul>
<p>Para comprobar que esto funciona abre varias pestañas en tu navegador (no vale pulsar F5 porque el navegador solicita entonces actualizar las cachés) y verás que todas llevan la misma hora de generación.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>Lo siguiente <strong>es una violación del protocolo HTTP:</strong> Si realmente queremos ignorar a los usuarios que pulsen F5 se puede añadir una opción al final de la línea y dejarla como <code class="docutils literal notranslate"><span class="pre">refresh_pattern</span> <span class="pre">$php</span> <span class="pre">2</span> <span class="pre">50%</span> <span class="pre">9</span> <span class="pre">ignore-reload</span></code> Con ello, Squid ignorará todas las peticiones de recarga incluso aunque se pulse F5</p>
</div>
<p>Para aprender realmente todo lo que envía y recibe el navegador utiliza las herramientas del desarrollador (usa la tecla F12) y explora las distintas cabeceras que envía Firefox/Chrome/Edge.</p>
</div>
<div class="section" id="proxys-encadenados">
<h2>Proxys  encadenados.<a class="headerlink" href="#proxys-encadenados" title="Enlazar permanentemente con este título">¶</a></h2>
</div>
<div class="section" id="pruebas-de-funcionamiento-herramientas-graficas">
<h2>Pruebas de funcionamiento. Herramientas gráficas.<a class="headerlink" href="#pruebas-de-funcionamiento-herramientas-graficas" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En Ubuntu es posible instalar un programa llamado <code class="docutils literal notranslate"><span class="pre">squidclient</span></code> que permite hacer consultas sencillas al servidor Squid y obtener muchas estadísticas sobre el uso de memoria, CPU y disco. Para instalarlo puede usarse <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">squidclient</span></code> y una vez instalado usar <code class="docutils literal notranslate"><span class="pre">squidclient</span> <span class="pre">mgr:info</span></code> para obtener los valores de uso.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tema_lopd/tema_lopd.html" class="btn btn-neutral float-right" title="Legislación y normas sobre seguridad" accesskey="n" rel="next">Siguiente <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../tema_sad/tema_sad.html" class="btn btn-neutral float-left" title="Implantación de soluciones de alta disponibilidad" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Anterior</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Oscar GG

    </p>
  </div>
    
    
    
    Construido con <a href="http://sphinx-doc.org/">Sphinx</a> usando un
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">tema</a>
    
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>