

<!DOCTYPE html>
<html class="writer-html5" lang="es" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Instalación y configuración de cortafuegos &mdash; documentación de Apuntes de Seguridad y alta disponibilidad - 1.0</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="../genindex.html" />
    <link rel="search" title="Búsqueda" href="../search.html" />
    <link rel="next" title="Implantación de soluciones de alta disponibilidad" href="../tema_sad/tema_sad.html" />
    <link rel="prev" title="Adopción de pautas de seguridad informática" href="../tema_pautas_seguridad_informatica/tema_pautas_seguridad_informatica.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Inicio de Documentación"> Apuntes de Seguridad y alta disponibilidad
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contenidos:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tema_pautas_seguridad_informatica/tema_pautas_seguridad_informatica.html">Adopción de pautas de seguridad informática</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Instalación y configuración de cortafuegos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#definicion-de-cortafuegos">Definición de cortafuegos</a></li>
<li class="toctree-l2"><a class="reference internal" href="#recordatorio-de-los-conceptos-basicos-de-redes">Recordatorio de los conceptos básicos de redes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utilizacion-de-cortafuegos">Utilización de cortafuegos.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#filtrado-de-paquetes-de-datos">Filtrado de paquetes de datos.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tipos-de-cortafuegos-caracteristicas-funciones-principales">Tipos de cortafuegos. Características. Funciones principales.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instalacion-de-cortafuegos-ubicacion">Instalación de cortafuegos. Ubicación.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reglas-de-filtrado-de-cortafuegos">Reglas de filtrado de cortafuegos.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gestion-de-tablas">Gestión de tablas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gestion-de-cadenas">Gestión de cadenas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gestion-de-reglas">Gestión de reglas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acciones-sobre-paquetes">Acciones sobre paquetes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pruebas-de-funcionamiento-sondeo">Pruebas de funcionamiento. Sondeo.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#registros-de-sucesos-de-un-cortafuegos">Registros de sucesos de un cortafuegos.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cortafuegos-integrados-en-los-sistemas-operativos">Cortafuegos integrados en los sistemas operativos.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cortafuegos-libres-y-propietarios">Cortafuegos libres y propietarios.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#distribuciones-libres-para-implementar-cortafuegos-en-maquinas-dedicadas">Distribuciones libres para implementar cortafuegos en máquinas dedicadas.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cortafuegos-hardware">Cortafuegos hardware.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#anexo-configuracion-de-ip-en-linux-con-netplan">Anexo: configuración de IP en Linux con Netplan</a></li>
<li class="toctree-l2"><a class="reference internal" href="#anexo-ejercicio-de-configuracion">Anexo: ejercicio de configuración</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ejemplo-denegacion-del-servidor-web-al-exterior">Ejemplo: denegación del servidor web al exterior</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#anexo-resolucion-de-problemas">Anexo: resolución de problemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#un-ejercicio-comentado">Un ejercicio comentado</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#solucion-1-erronea">Solución 1 (errónea)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#una-solucion-un-poco-mejor">Una solución un poco mejor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Una solución (un poco mejor)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#otra-solucion">Otra solución</a></li>
<li class="toctree-l3"><a class="reference internal" href="#otra-solucion-mas-segura">Otra solución (más segura)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ejercicio-resuelto-con-ficheros">Ejercicio resuelto con ficheros</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#resolucion">Resolución</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tema_sad/tema_sad.html">Implantación de soluciones de alta disponibilidad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_sad/tema_sad.html#ejercicio-recuperando-una-web-con-vagrant">Ejercicio: recuperando una web con Vagrant</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_proxys/tema_proxys.html">Instalación y configuración de servidores  proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_lopd/tema_lopd.html">Legislación y normas sobre seguridad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tema_acceso_remoto/tema_acceso_remoto.html">Implantación de técnicas de acceso remoto. Seguridad perimetral</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apuntes de Seguridad y alta disponibilidad</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Instalación y configuración de cortafuegos</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tema_cortafuegos/tema_cortafuegos.rst.txt" rel="nofollow"> Ver código fuente de la página</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="instalacion-y-configuracion-de-cortafuegos">
<h1>Instalación y configuración de cortafuegos<a class="headerlink" href="#instalacion-y-configuracion-de-cortafuegos" title="Enlazar permanentemente con este título">¶</a></h1>
<div class="section" id="definicion-de-cortafuegos">
<h2>Definición de cortafuegos<a class="headerlink" href="#definicion-de-cortafuegos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Un cortafuegos o «firewall» es un programa que examina los paquetes de red entrantes y salientes y decide autorizar o no el paso en función de las reglas que dictamine el administrador.</p>
<p>A pesar de ser un software existen fabricantes de hardware que venden «dispositivos cortafuegos». Estos dispositivos suelen ser routers que incluyen de serie el software cortafuegos.</p>
</div>
<div class="section" id="recordatorio-de-los-conceptos-basicos-de-redes">
<h2>Recordatorio de los conceptos básicos de redes<a class="headerlink" href="#recordatorio-de-los-conceptos-basicos-de-redes" title="Enlazar permanentemente con este título">¶</a></h2>
<ul class="simple">
<li><p>Dirección IP: todo paquete de datos lleva una IP de origen y una de destino.</p></li>
<li><p>Puerto: número asociado a un cierto programa o servicio. Todo paquete lleva un puerto de origen y un puerto de destino.</p></li>
</ul>
<p>Cuando un paquete llega a una máquina es posible que haya que tomar una decisión como:</p>
<ul class="simple">
<li><p>Permitir el paso del paquete.</p></li>
<li><p>Denegar el paso.</p></li>
<li><p>Redirigirlo a otra máquina</p></li>
</ul>
<p>Para ello podemos usar cualquier parámetro de TCP/IP, como por ejemplo.</p>
<ul class="simple">
<li><p>Autorizar o no dependiendo de la IP de origen.</p></li>
<li><p>Autorizar o no dependiendo de la IP de destino.</p></li>
<li><p>Basarnos en el puerto de destino. Dado que los puertos de origen suelen ser aleatorios <strong>es muy poco probable que nos basemos en el puerto de origen</strong> . Debe recordarse también que hay que indicar claramente si el puerto será <strong>TCP o UDP</strong>.</p></li>
<li><p>También es posible que usemos otros protocolos para tomar la decisión, por ejemplo <code class="docutils literal notranslate"><span class="pre">&lt;prohibir</span> <span class="pre">todos</span> <span class="pre">los</span> <span class="pre">paquetes</span> <span class="pre">ICMP&gt;</span></code></p></li>
<li><p>Aunque es poco probable es posible que haya que examinar algún flag del protocolo (RST, SYN, ACK…)</p></li>
</ul>
</div>
<div class="section" id="utilizacion-de-cortafuegos">
<h2>Utilización de cortafuegos.<a class="headerlink" href="#utilizacion-de-cortafuegos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Un cortafuegos es un programa que se ejecuta en los niveles más básicos del sistema operativo. Para utilizar esta capacidad es posible que tengamos dos grandes tipos de interfaz.</p>
<ul class="simple">
<li><p>Un interfaz gráfico (estilo Windows): en este curso analizaremos como usar el cortafuegos de Windows 2016.</p></li>
<li><p>Un interfaz basado en comandos (estilo Unix): en este curso veremos como funciona <code class="docutils literal notranslate"><span class="pre">nftables</span></code></p></li>
</ul>
</div>
<div class="section" id="filtrado-de-paquetes-de-datos">
<h2>Filtrado de paquetes de datos.<a class="headerlink" href="#filtrado-de-paquetes-de-datos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Una de las utilidades principales de un cortafuegos es denegar la entrada o salida de ciertos tipos de tráfico basándonos en distintos parámetros que ya se han mencionado antes:</p>
<ul class="simple">
<li><p>La IP de origen y/o destino.</p></li>
<li><p>El puerto de origen y/o destino.</p></li>
<li><p>El protocolo.</p></li>
<li><p>Otros parámetros…</p></li>
</ul>
<p>En los apartados posteriores veremos como usar un cortafuegos de red para permitir o denegar tráfico basándonos en estos datos.</p>
</div>
<div class="section" id="tipos-de-cortafuegos-caracteristicas-funciones-principales">
<h2>Tipos de cortafuegos. Características. Funciones principales.<a class="headerlink" href="#tipos-de-cortafuegos-caracteristicas-funciones-principales" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Hay muchas maneras de organizar la arquitectura del cortafuegos de una red. En este curso usaremos la más simple, reflejada en la figura siguiente. En ella, un dispositivo controla todo el tráfico de entrada y salida de una red. Por desgracia tiene el inconveniente de que si un intruso logra «saltarse» el cortafuegos tendrá acceso total a toda la red.</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../_images/Cortafuegos.png"><img alt="Estructura de un cortafuegos (Fuente:Wikipedia)" src="../_images/Cortafuegos.png" style="width: 150.0px; height: 82.5px;" /></a>
<p class="caption"><span class="caption-text">Estructura de un cortafuegos (Fuente:Wikipedia)</span><a class="headerlink" href="#id2" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>El mecanismo más utilizado hoy en día es la creación de una «zona desmilitarizada» o DMZ y requiere varios dispositivos. También se conoce por el nombre de «screened host».</p>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../_images/dmz.png"><img alt="Arquitectura de una DMZ (Fuente: RedIris)." src="../_images/dmz.png" style="width: 250.0px; height: 150.0px;" /></a>
<p class="caption"><span class="caption-text">Arquitectura de una DMZ (Fuente: RedIris).</span><a class="headerlink" href="#id3" title="Enlace permanente a esta imagen">¶</a></p>
</div>
</div>
<div class="section" id="instalacion-de-cortafuegos-ubicacion">
<h2>Instalación de cortafuegos. Ubicación.<a class="headerlink" href="#instalacion-de-cortafuegos-ubicacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En GNU/Linux podemos instalar <strong>NFTables</strong>, una arquitectura de filtrado de paquetes que se integra con el núcleo de Linux y reemplaza al anterior <strong>IPTables</strong> . Para instalarlo podemos hacer lo siguiente:</p>
<ul class="simple">
<li><p>Ejecutar <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">update</span></code> y <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">upgrade</span></code> para asegurarnos de recargar la información de interés sobre paquetes.</p></li>
<li><p>Ejecutar <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">remove</span> <span class="pre">iptables</span></code> para asegurarnos de que no tengamos varios sistemas de filtrado ejecutándose a la vez.</p></li>
<li><p>Ejecutar <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">nftables</span></code> para instalar <strong>NFTables</strong> .</p></li>
</ul>
<p>Una vez hecho esto deberíamos tener disponible el comando <code class="docutils literal notranslate"><span class="pre">nft</span></code> que permite el acceso al sistema de filtrado.</p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>El comando <code class="docutils literal notranslate"><span class="pre">nft</span></code> debe ejecutarse <strong>SIEMPRE</strong> como administrador. Si olvidamos poner <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">...</span></code> es probable que el comando <em>no devuelva ningún error</em> ya que es posible permitir a otros usuarios ejecutar el comando. Así, aunque no se diga expresamente <strong>DEBEREMOS EJECUTAR SIEMPRE ESTE COMANDO COMO SUPERUSUARIOS</strong>  . Otra alternativa es convertirnos primero en superusuarios con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">su</span></code> y a partir de ahí lanzar todos los comandos que necesitemos.</p>
</div>
<p>En este tema usaremos unas de las configuraciones más habituales: situar el cortafuegos entre nuestra red y el resto de Internet, haciendo que nuestro equipo no solo haga NAT sino que también permita filtrar el tráfico entre ambas redes.</p>
</div>
<div class="section" id="reglas-de-filtrado-de-cortafuegos">
<h2>Reglas de filtrado de cortafuegos.<a class="headerlink" href="#reglas-de-filtrado-de-cortafuegos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>NFTables es la nueva arquitectura de filtrado y manipulación de paquetes de red en el núcleo de Linux.Como NFTables puede procesar muchos datos de red es importante saber que distingue entre varias «familias de protocolos de red». En concreto podemos usar estas familias:</p>
<ul class="simple">
<li><p>«ip»: se refiere a IPv4</p></li>
<li><p>«ip6»: para IPv6</p></li>
<li><p>«inet»: para tratar tanto con IPv4 como IPv6.</p></li>
<li><p>«arp»: para tramas Ethernet. No lo usaremos en este tema.</p></li>
<li><p>«bridge»: para tramas Ethernet que «crucen» este equipo cuando esté siendo usado como switch. No lo usaremos en este tema.</p></li>
<li><p>«netdev»: en general solo para programadores que deseen examinar todo el tráfico que entre en la tarjeta.</p></li>
</ul>
<p>El comando básico de acceso a todas las operaciones es <code class="docutils literal notranslate"><span class="pre">nft</span></code>. En líneas generales <code class="docutils literal notranslate"><span class="pre">nft</span></code> examina los paquetes y analiza las reglas que se le dan para decidir que hacer con un paquete de red. Para ello es importante tener claro que <code class="docutils literal notranslate"><span class="pre">nft</span></code> usa «hooks», «tablas», «cadenas» y «reglas».</p>
<p>Un «hook» es una etapa en la que está un paquete. En el dibujo siguiente se puede ver las etapas en las que está un paquete IP</p>
<div class="figure align-default" id="id4">
<a class="reference internal image-reference" href="../_images/hooks.png"><img alt="Hooks" src="../_images/hooks.png" style="width: 656.8000000000001px; height: 124.0px;" /></a>
<p class="caption"><span class="caption-text">«Hooks» o etapas de un paquete de red. (Figura sacada de la web de NFTables)</span><a class="headerlink" href="#id4" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<ul class="simple">
<li><p>«Prerouting»: el paquete aún no ha entrado en la tabla de enrutamiento.</p></li>
<li><p>«Input»: el paquete era para nosotros pero aún no ha entrado en ningún programa.</p></li>
<li><p>«Output»: un paquete sale de un programa nuestro pero aún no se ha decidido qué hacer con él.</p></li>
<li><p>«Postrouting»: un paquete que sale de un programa nuestro ya ha cruzado la tabla de enrutamiento.</p></li>
<li><p>«Forwarding»: se usa para paquetes que «cruzan» nuestra máquina pero no van dirigidas a «esta máquina».</p></li>
</ul>
<p>Es decir, el tráfico que «entre» verá los hooks «prerouting» e «input». El que sale de nuestro ordenador verá «ouput» y «postrouting». El tráfico que atraviesa nuestro equipo Linux cuando esté funcionando como router verá «forwarding».</p>
<ul class="simple">
<li><p>Una «tabla» indica el protocolo que queremos analizar, puede ser «ip», «ip6», «arp», «bridge» y otros. Así, tenemos comandos como <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">list</span> <span class="pre">tables</span></code> o <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">list</span> <span class="pre">tables</span> <span class="pre">ip</span></code> que nos permiten examinar qué hemos hecho con los distintos protocolos. Por ejemplo, podemos crear una tabla con el comando <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">TablaFiltradoSQL</span></code> y la podemos borrar con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">delete</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">TablaFiltradoSQL</span></code>. Es decir la pauta es <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">(add|remove)</span> <span class="pre">table</span> <span class="pre">&lt;familia&gt;</span> <span class="pre">&lt;NombreDeLaTabla&gt;</span></code>.</p></li>
<li><dl class="simple">
<dt>Una «cadena» indica un conjunto de reglas que <code class="docutils literal notranslate"><span class="pre">nft</span></code> irá examinando por orden para decidir qué hacer con un paquete. Una cadena puede ser «base» o «no base». Una cadena «base» puede ver TODO el tráfico TCP y una «no base» al principio no ve nada. En una cadena hay que indicar:</dt><dd><ul>
<li><p>Qué tipo de manipulación queremos aplicar en un protocolo. Las posibles manipulaciones son «filter», «route» y «nat».</p></li>
<li><p>En una cadena también hay que indicar la etapa o hook.</p></li>
<li><p>Se debe indicar la prioridad, que es un número que determina el orden de las reglas. Una regla con la prioridad 20 se examina antes que una con prioridad 30.</p></li>
<li><p>Se debe indicar la política que será una de dos: <code class="docutils literal notranslate"><span class="pre">accept</span></code> o <code class="docutils literal notranslate"><span class="pre">drop</span></code>. Si no se pone nada se asume que la política es «accept».</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Una «regla» siempre va metida dentro de una cadena. Toda regla tiene:</dt><dd><ul>
<li><p>Un identificador o «handle», que podríamos también llamar el «código de regla».</p></li>
<li><p>Una posición dentro de la cadena. Si por ejemplo creamos primero la regla 10, y luego la 20, podemos despues insertar una regla entre medias con la posición 15. De hecho es aconsejable no usar números de regla consecutivos.</p></li>
<li><p>Una regla PUEDE llevar un «match» que permite crear «condiciones» para saber si una regla se aplica o no. Por ejemplo una regla se podría aplicar solo a paquetes que superen una cierta longitud.</p></li>
<li><p>Si ponemos un «match» entonces DEBE haber una sentencia, que indique lo que se tiene que hacer en ese caso.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Una vez configurado todo podemos hacer lo siguiente:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">list</span> <span class="pre">ruleset</span></code> muestra <strong>toda la configuración del cortafuegos</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">list</span> <span class="pre">ruleset</span> <span class="pre">&gt;</span> <span class="pre">ficheronftables.conf</span></code></p></li>
<li><p>Si el fichero anterior lo ponemos «encima» del fichero <code class="docutils literal notranslate"><span class="pre">/etc/nftables.conf</span></code> el sistema operativo recargará esta configuración. El comando sería algo como <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cp</span> <span class="pre">ficheronftables.conf</span> <span class="pre">/etc/nftables.conf</span></code></p></li>
</ul>
<div class="section" id="gestion-de-tablas">
<h3>Gestión de tablas<a class="headerlink" href="#gestion-de-tablas" title="Enlazar permanentemente con este título">¶</a></h3>
<p>En los puntos siguientes vemos algunas operaciones básicas con tablas:</p>
<ul class="simple">
<li><p>Crear una tabla que trabaje con el protocolo IPv4: <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoBD</span></code></p></li>
<li><p>Crear una tabla que trabaje con IP en general (ya sea version 4 o 6): <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">inet</span> <span class="pre">filtradoWeb</span></code></p></li>
<li><p>Ver las tablas del cortafuegos: <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">list</span> <span class="pre">tables</span></code></p></li>
<li><p>Borrar una tabla: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">delete</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoBD</span></code> o <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">delete</span> <span class="pre">table</span> <span class="pre">inet</span> <span class="pre">filtradoWeb</span></code></p></li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Peligro</p>
<p>Se puede borrar <strong>absolutamente todas las tablas</strong> usando el comando <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">flush</span> <span class="pre">ruleset</span></code>.</p>
</div>
</div>
<div class="section" id="gestion-de-cadenas">
<h3>Gestión de cadenas<a class="headerlink" href="#gestion-de-cadenas" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Supongamos una tabla cualquiera de tipo «ip» y llamada por ejemplo «filtradoUsuarios». Podemos trabajar con ella con comandos como los siguientes:</p>
<ul class="simple">
<li><p>Creamos una cadena para examinar por ejemplo el trafico de entrada, pero refiriéndonos <strong>«tráfico cuyo destino sera algún servidor que esté instalado en el mismo ordenador del cortafuegos</strong> . Dicha cadena se llamara «traficoEntrada»: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">{type</span> <span class="pre">filter</span> <span class="pre">hook</span> <span class="pre">input</span> <span class="pre">priority</span> <span class="pre">0\;</span> <span class="pre">}</span></code></p></li>
</ul>
</div>
<div class="section" id="gestion-de-reglas">
<h3>Gestión de reglas<a class="headerlink" href="#gestion-de-reglas" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Supongamos una tabla cualquiera de tipo «ip» y llamada por ejemplo «filtradoUsuarios» y supongamos que dentro hay una cadena llamada «traficoEntrada» y que dicha regla examina el tráfico de entrada.</p>
<ul class="simple">
<li><p>Podemos por ejemplo rechazar que alguien se conecte desde fuera poniendo una regla que prohiba el tráfico de entrada que intente conectarse a nuestro puerto 22 (el de SSH). Recordemos que dichas personas usarán como puerto de destino el 22.</p></li>
<li><p>Podemos borrar toda la cadena con <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">flush</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span></code></p></li>
<li><p>Podemos borrar una regla si conocemos su handle. Para averiguarlo podemos listar la tabla con <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">list</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span></code></p></li>
</ul>
<p>En general, en todos los casos necesitamos un mecanismo para <strong>determinar qué campos de un paquete queremos examinar, los «matches»</strong>. En NFTables, un match puede ser algo como esto:</p>
<ul>
<li><p>Comprobar la IP de origen; <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">192.168.47.5</span> <span class="pre">drop</span></code>. Esta regla <strong>descarta</strong> (drop) paquetes cuya IP de origen (Source ADDRess) sea 192.168.47.5.</p></li>
<li><p>Comprobar la IP de destino; <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">ip</span> <span class="pre">daddr</span> <span class="pre">10.45.10.10</span> <span class="pre">drop</span></code>. Esta regla <strong>descarta</strong> (drop) paquetes cuya IP de destino (Destination ADDRess) sea 10.45.10.10.</p></li>
<li><p>Se pueden usar rangos de IP: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">ip</span> <span class="pre">daddr</span> <span class="pre">10.45.10.0/24</span> <span class="pre">drop</span></code>. Esta regla <strong>descarta</strong> (drop) paquetes cuya IP de destino (Destination ADDRess) sea del tipo 10.45.10.xxx.</p></li>
<li><p>Comprobar ambos campos a la vez: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">192.168.47.5</span> <span class="pre">daddr</span> <span class="pre">10.45.10.10</span> <span class="pre">drop</span></code>. Esta regla descarta los paquetes cuya IP de origen sea 192.168.47.5 y vayan destinados a la IP 10.45.10.10.</p></li>
<li><p>Comprobar el puerto de origen: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">drop</span></code>. Esta regla descarta <strong>TODO EL TRÁFICO</strong> cuyo puerto de destino sea el 80.</p></li>
<li><p>Mezclar campos: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">drop</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">192.168.47.5</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">443</span></code>. Esta regla <strong>descarta todo el tráfico cuyo IP de origen sea 192.168.47.5 y cuyo puerto de destino sea el 443</strong></p></li>
<li><p>Usar rangos de puertos incluso mezclando con rangos de IP:  <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">drop</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">192.168.1.0/24</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">1-1024</span></code>. Esta regla <strong>descarta todo el tráfico cuyo IP de origen sea 192.168.1.xxx y cuyo puerto de destino esté entre 1 y 1024</strong></p></li>
<li><p>Usar cantidad de tráfico: examinemos las siguientes reglas (nota, es importante que las reglas que limitan la cantidad de tráfico vayan en la cadena correcta, en concreto en <code class="docutils literal notranslate"><span class="pre">prerouting</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">192.168.1.45</span> <span class="pre">limit</span> <span class="pre">rate</span> <span class="pre">100kbytes/second</span> <span class="pre">accept</span></code> : se autoriza el tráfico desde la IP que se mantenga en un ratio de hasta 100kbytes por segundos.</p></li>
<li><p>La regla de arriba no basta para limitar el tráfico, pero si ahora añadimos esto <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoUsuarios</span> <span class="pre">traficoEntrada</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">192.168.1.45</span> <span class="pre">limit</span> <span class="pre">rate</span> <span class="pre">over</span> <span class="pre">100kbytes/second</span> <span class="pre">drop</span></code> ahora tenemos una segunda regla que indica que <strong>si se excede el límite de 100kbytes/seg entonces el tráfico se descarta</strong>. Esto constituye un mecanismo excelente para «regular el tráfico».</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Podemos «abrir puertos» en el cortafuegos con NAT usando reglas como esta en la tabla que haga NAT: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">tablaNAT</span> <span class="pre">natEntrada</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">dnat</span> <span class="pre">to</span> <span class="pre">192.168.100.10:80</span></code> que significa algo como «cuando llegue una conexión al puerto 80 de la ip de este cortafuegos redirigir la conexión hacie al puerto 80 de la IP 192.168.100.10»</p></li>
</ul>
</div>
<div class="section" id="acciones-sobre-paquetes">
<h3>Acciones sobre paquetes<a class="headerlink" href="#acciones-sobre-paquetes" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Hemos visto hasta ahora la acción <code class="docutils literal notranslate"><span class="pre">drop</span></code> (descartar), pero se pueden usar también:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">counter</span></code>: nos permite hacer un recuento de bytes/paquetes que cumplen una cierta regla (y por ejemplo «llevar la contabilidad de descargas».</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accept</span></code> : si una cadena utiliza por defecto la acción <code class="docutils literal notranslate"><span class="pre">drop</span></code> es posible que nos interese permitir algunos paquetes.</p></li>
</ul>
</div>
</div>
<div class="section" id="pruebas-de-funcionamiento-sondeo">
<h2>Pruebas de funcionamiento. Sondeo.<a class="headerlink" href="#pruebas-de-funcionamiento-sondeo" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para comprobar el funcionamiento de un cortafuegos se pueden usar varias técnicas:</p>
<ul class="simple">
<li><p>Usar una herramienta genérica de gestión de redes, como <code class="docutils literal notranslate"><span class="pre">netcat</span></code>.</p></li>
<li><p>Usar una herramienta específica de comprobación de puertos como <code class="docutils literal notranslate"><span class="pre">nmap</span></code></p></li>
<li><p>Usar los ficheros de <code class="docutils literal notranslate"><span class="pre">log</span></code> para registrar la actividad de la red.</p></li>
</ul>
</div>
<div class="section" id="registros-de-sucesos-de-un-cortafuegos">
<h2>Registros de sucesos de un cortafuegos.<a class="headerlink" href="#registros-de-sucesos-de-un-cortafuegos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Se puede registrar el tráfico que entra en un cortafuegos como <code class="docutils literal notranslate"><span class="pre">nft</span></code> . Para ello, se debe usar la acción <code class="docutils literal notranslate"><span class="pre">log</span></code> por ejemplo mediante reglas como las siguientes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">tablaFiltrado</span> <span class="pre">cadenaEntrada</span> <span class="pre">log</span></code> . Esto registra <em>absolutamente todo el tráfico</em> que circule por esa cadena. Aunque puede ser de mucha utilidad, esto puede ser excesivo.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">tablaFiltrado</span> <span class="pre">cadenaEntrada</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">log</span></code> . Esto registra solo el tráfico de entrada HTTP.</p></li>
</ul>
<p>Los registros del cortafuegos van al fichero <code class="docutils literal notranslate"><span class="pre">/etc/syslog</span></code></p>
</div>
<div class="section" id="cortafuegos-integrados-en-los-sistemas-operativos">
<h2>Cortafuegos integrados en los sistemas operativos.<a class="headerlink" href="#cortafuegos-integrados-en-los-sistemas-operativos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Windows incluye un cortafuegos como parte integral de su</p>
</div>
<div class="section" id="cortafuegos-libres-y-propietarios">
<h2>Cortafuegos libres y propietarios.<a class="headerlink" href="#cortafuegos-libres-y-propietarios" title="Enlazar permanentemente con este título">¶</a></h2>
</div>
<div class="section" id="distribuciones-libres-para-implementar-cortafuegos-en-maquinas-dedicadas">
<h2>Distribuciones libres para implementar cortafuegos en máquinas dedicadas.<a class="headerlink" href="#distribuciones-libres-para-implementar-cortafuegos-en-maquinas-dedicadas" title="Enlazar permanentemente con este título">¶</a></h2>
</div>
<div class="section" id="cortafuegos-hardware">
<h2>Cortafuegos hardware.<a class="headerlink" href="#cortafuegos-hardware" title="Enlazar permanentemente con este título">¶</a></h2>
</div>
<div class="section" id="anexo-configuracion-de-ip-en-linux-con-netplan">
<h2>Anexo: configuración de IP en Linux con Netplan<a class="headerlink" href="#anexo-configuracion-de-ip-en-linux-con-netplan" title="Enlazar permanentemente con este título">¶</a></h2>
<p>La herramienta <code class="docutils literal notranslate"><span class="pre">netplan</span></code> utiliza ficheros YAML para configurar la IP en Linux. En distribuciones Linux orientadas a servidores es la herramienta que se usará en el futuro para configurar todos los parámetros de red. La estructura de estos ficheros permite indicar parámetros y subparámetros de configuración usando 4 espacios. Así, el fichero típico de <code class="docutils literal notranslate"><span class="pre">netplan</span></code> es como sigue:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">network</span><span class="p">:</span>
    <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span> <span class="c1">#Version de YAML que se usan</span>
    <span class="nt">ethernets</span><span class="p">:</span> <span class="c1">#Configuración de tarjetas Ethernet</span>
        <span class="l l-Scalar l-Scalar-Plain">enp0s3:#Nombre de la tarjeta a configurar</span>
            <span class="l l-Scalar l-Scalar-Plain">#Se pueden poner muchas direcciones</span>
            <span class="l l-Scalar l-Scalar-Plain">#usando corchetes y separando por comas</span>
            <span class="l l-Scalar l-Scalar-Plain">addresses</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">192.168.100/24</span><span class="p p-Indicator">]</span>
            <span class="c1">#Dirección del router que nos permitirá</span>
            <span class="c1">#salir al exterior</span>
            <span class="nt">gateway4</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.100.1</span>
            <span class="nt">nameservers</span><span class="p">:</span>
                <span class="nt">addresses</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">10.15.0.220</span><span class="p p-Indicator">,</span> <span class="nv">8.8.8.8</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<div class="section" id="anexo-ejercicio-de-configuracion">
<h2>Anexo: ejercicio de configuración<a class="headerlink" href="#anexo-ejercicio-de-configuracion" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="figure align-default" id="id5">
<a class="reference internal image-reference" href="../_images/Esquema-de-red.png"><img alt="Ejemplos de permisos" src="../_images/Esquema-de-red.png" style="width: 337.0px; height: 79.0px;" /></a>
<p class="caption"><span class="caption-text">Ejemplos de configuración de una red.</span><a class="headerlink" href="#id5" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>Se supone que tenemos dos máquinas</p>
<ul class="simple">
<li><p>La máquina de la izquierda es un cliente. Todo su tráfico pasa por la máquina central que no solo hace NAT sino que también regula el tráfico de entrada y salida por medio de un cortafuegos. La máquina de la izquierda puede ser de cualquier tipo, en nuestro caso usaremos una máquina con Windows 7.</p></li>
<li><p>La máquina central será una Ubuntu Server con dos tarjetas de red configuradas mediante <code class="docutils literal notranslate"><span class="pre">netplan</span></code>.</p></li>
</ul>
<p>En la Ubuntu Server habrá que hacer algunas operaciones:</p>
<ul class="simple">
<li><p>Se debe activar el enrutamiento. Esto puede hacerse con el comando <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">1</span> <span class="pre">&gt;</span> <span class="pre">/proc/sys/net/ip_forward</span></code>  pero se desactivará en el siguiente reinicio. Por eso es mejor dejar activado el enrutamiento en el arranque editando el fichero <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code> . Se debe escribir una línea en el fichero que ponga «net.ipv4.ip_forward=1» (es muy posible que ya exista la línea y solo haya que quitar el comentario inicial). Una vez modificado se puede ejecutar <code class="docutils literal notranslate"><span class="pre">sysctl</span> <span class="pre">-p</span></code> para iniciar el servicio (que quedará activado para siempre).</p></li>
<li><p>Se debe instalar en Ubuntu el servidor web con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">apache2</span></code></p></li>
<li><p>Se debe poner en marcha el NAT. Para ello podemos añadir algo como lo siguiente al fichero <code class="docutils literal notranslate"><span class="pre">/etc/nftables.conf</span></code>. Por favor, recuerda cambiar el nombre de la interfaz de salida, es posible que en tu máquina no se llame <code class="docutils literal notranslate"><span class="pre">enp0s8</span></code></p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>table ip nat {
    chain prerouting {
        type nat hook prerouting priority 0; policy accept;
    }
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        oifname &quot;enp0s8&quot; masquerade
    }
}
</pre></div>
</div>
<div class="section" id="ejemplo-denegacion-del-servidor-web-al-exterior">
<h3>Ejemplo: denegación del servidor web al exterior<a class="headerlink" href="#ejemplo-denegacion-del-servidor-web-al-exterior" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Se nos pide lo siguiente: <em>«permitir que los clientes de dentro de la red SÍ puedan ver el servidor web instalado en el propio servidor donde está el cortafuegos»</em></p>
<div class="admonition warning">
<p class="admonition-title">Advertencia</p>
<p>En los párrafos siguientes se muestra una decisión que «técnicamente funciona» pero que puede ser una mala decisión por motivos que se comentarán despues.</p>
</div>
<p>Supongamos que creamos una tabla donde meteremos todas las decisiones que afectan al servidor web. Usaremos <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoweb</span></code>.</p>
<p>Supongamos también que creamos una cadena que se ocupará de denegar el tráfico web en la etapa de «prerouting» con <code class="docutils literal notranslate"><span class="pre">nft</span> <span class="pre">add</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoweb</span> <span class="pre">denegacionApache</span> <span class="pre">{type</span> <span class="pre">filter</span> <span class="pre">hook</span> <span class="pre">prerouting</span> <span class="pre">priority</span> <span class="pre">0</span> <span class="pre">\;</span> <span class="pre">policy</span> <span class="pre">accept</span> <span class="pre">\;}</span></code></p>
<p>Comentario: antes hemos dicho que hay malas decisiones.</p>
<ul class="simple">
<li><p>Por ejemplo, la política por defecto es «accept». Quizá fuera más seguro poner por defecto «drop» y luego permitir solo lo que nos interese.</p></li>
<li><p>Examinamos el tráfico en la etapa de «prerouting» pero eso obliga al sistema operativo a comprobar muchísimos paquetes, algunos de los cuales no irán dirigidos a nosotros. Otra posibilidad sería vincular nuestra cadena a la etapa «input»</p></li>
</ul>
</div>
</div>
<div class="section" id="anexo-resolucion-de-problemas">
<h2>Anexo: resolución de problemas<a class="headerlink" href="#anexo-resolucion-de-problemas" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Si algo va mal comprueba lo siguiente:</p>
<ul class="simple">
<li><p>Lanza el comando <code class="docutils literal notranslate"><span class="pre">nft</span></code>  como superusuario, es decir en realidad debes hacer <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span></code>.</p></li>
<li><p>Si has aplicado una regla y parece que no funciona, asegúrate de que la pones en el «hook» correcto.</p></li>
<li><p>Si no puedes enrutar, asegúrate de que has activado el enrutado o «forwarding» en el núcleo. Repasa el fichero y ábrelo con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nano</span> <span class="pre">/etc/sysctl.conf</span></code> . La línea que controla el forwarding debe ser así <code class="docutils literal notranslate"><span class="pre">net.ipv4.forward=1</span></code> .</p></li>
</ul>
</div>
<div class="section" id="un-ejercicio-comentado">
<h2>Un ejercicio comentado<a class="headerlink" href="#un-ejercicio-comentado" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Supongamos que tenemos la misma configuración de siempre, que volvemos a mostrar en la figura siguiente:</p>
<div class="figure align-default" id="id6">
<a class="reference internal image-reference" href="../_images/Esquema-de-red.png"><img alt="Ejemplos de permisos" src="../_images/Esquema-de-red.png" style="width: 337.0px; height: 79.0px;" /></a>
<p class="caption"><span class="caption-text">Ejemplos de configuración de una red.</span><a class="headerlink" href="#id6" title="Enlace permanente a esta imagen">¶</a></p>
</div>
<p>Y supongamos que nos piden lo siguiente:</p>
<blockquote>
<div><p><em>Asumiendo que los ordenadores de la izquierda son una «red interna» y que el resto son «el exterior» instalar un servidor web en el equipo del cortafuegos y conseguir que solo «el interior» pueda conectarse al servidor web</em></p>
</div></blockquote>
<div class="section" id="solucion-1-erronea">
<h3>Solución 1 (errónea)<a class="headerlink" href="#solucion-1-erronea" title="Enlazar permanentemente con este título">¶</a></h3>
<ol class="arabic simple">
<li><p>Ejecutamos <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">flush</span> <span class="pre">ruleset</span></code> para limpiar el cortafuegos.</p></li>
<li><p>Construimos una tabla con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span></code> y comprobamos su creación con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">list</span> <span class="pre">tables</span></code></p></li>
<li><p>Comprobamos que realmente ni siquiera hay cadenas en la tabla creada con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">list</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span></code></p></li>
</ol>
<div class="admonition danger">
<p class="admonition-title">Peligro</p>
<p>A partir de aquí lo vamos a hacer mal simplemente para hacer la prueba</p>
</div>
<ol class="arabic simple" start="4">
<li><p>Construimos una cadena que examine el tráfico en <code class="docutils literal notranslate"><span class="pre">prerouting</span></code> con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoApache</span> <span class="pre">{</span> <span class="pre">type</span> <span class="pre">filter</span> <span class="pre">hook</span> <span class="pre">prerouting</span> <span class="pre">priority</span> <span class="pre">0\;</span> <span class="pre">policy</span> <span class="pre">accept\;</span>&#160;&#160; <span class="pre">}</span></code></p></li>
<li><p>Comprobamos que la cadena se ha creado con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">list</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span></code></p></li>
<li><p>Prohibimos el tráfico cuyo puerto de destino sea el 80 con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoApache</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">drop</span></code></p></li>
</ol>
<p>Por desgracia aquí hay algunos problemas:</p>
<ul class="simple">
<li><p>En primer lugar, esta configuración <strong>NO FUNCIONA</strong> . Se ha prohibido <em>todo el tráfico web</em> incluyendo, sin querer, a los de la red interna.</p></li>
<li><p>Además, hemos añadido comprobaciones en la etapa <code class="docutils literal notranslate"><span class="pre">prerouting</span></code> lo que sobrecarga mucho el cortafuegos, al obligarle a examinar <strong>TODO EL TRÁFICO</strong>. En realidad solo nos interesaba el tráfico de entrada, así que probablemente deberíamos haber usado la etapa <code class="docutils literal notranslate"><span class="pre">input</span></code></p></li>
</ul>
</div>
<div class="section" id="una-solucion-un-poco-mejor">
<h3>Una solución un poco mejor<a class="headerlink" href="#una-solucion-un-poco-mejor" title="Enlazar permanentemente con este título">¶</a></h3>
<ol class="arabic simple">
<li><p>Borramos las reglas con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">flush</span> <span class="pre">ruleset</span></code></p></li>
<li><p>Reconstruimos la tabla con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span></code></p></li>
<li><p>Reconstruimos la cadena con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoApache</span> <span class="pre">{</span> <span class="pre">type</span> <span class="pre">filter</span> <span class="pre">hook</span> <span class="pre">prerouting</span> <span class="pre">priority</span> <span class="pre">0\;</span> <span class="pre">policy</span> <span class="pre">accept\;</span>&#160;&#160; <span class="pre">}</span></code></p></li>
<li><p>Prohibimos el tráfico de las direcciones de la red «externa» con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoApache</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">10.0.0.0/8</span> <span class="pre">drop</span></code></p></li>
</ol>
<p>Esto funciona un poco mejor, pero en realidad «fuera» podría haber muchos rangos distintos, por lo que quizá hubiera que poner muchos (y quizá demasiados) rangos de IPs.</p>
</div>
<div class="section" id="id1">
<h3>Una solución (un poco mejor)<a class="headerlink" href="#id1" title="Enlazar permanentemente con este título">¶</a></h3>
<ol class="arabic simple">
<li><p>Borramos las reglas con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">flush</span> <span class="pre">ruleset</span></code></p></li>
<li><p>Reconstruimos la tabla con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span></code></p></li>
<li><p>Reconstruimos la cadena con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoApache</span> <span class="pre">{</span> <span class="pre">type</span> <span class="pre">filter</span> <span class="pre">hook</span> <span class="pre">prerouting</span> <span class="pre">priority</span> <span class="pre">0\;</span> <span class="pre">policy</span> <span class="pre">accept\;</span>&#160;&#160; <span class="pre">}</span></code></p></li>
<li><p>Ejecutamos <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoApache</span> <span class="pre">iifname</span> <span class="pre">enp0s8</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">drop</span></code></p></li>
</ol>
<p>Esta última regla es un poco mejor, porque ahora descartamos indicando que «prohibimos el tráfico que intente entrar al puerto 80 usando como interfaz de entrada (iifname o «input interface name») la tarjeta enp0s8» (o la que sea)</p>
</div>
<div class="section" id="otra-solucion">
<h3>Otra solución<a class="headerlink" href="#otra-solucion" title="Enlazar permanentemente con este título">¶</a></h3>
<ol class="arabic simple">
<li><p>Borramos las reglas con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">flush</span> <span class="pre">ruleset</span></code></p></li>
<li><p>Vamos a crear una tabla con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span></code></p></li>
<li><p>Examinamos el tráfico de entrada con una cadena que examine la etapa de red <code class="docutils literal notranslate"><span class="pre">input</span></code> con el comando <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoEntrada</span> <span class="pre">{type</span> <span class="pre">filter</span> <span class="pre">hook</span> <span class="pre">input</span> <span class="pre">priority</span> <span class="pre">0\;</span> <span class="pre">policy</span> <span class="pre">accept\;}</span></code></p></li>
<li><p>Cerramos el tráfico que entra por la tarjeta que nos conecta al exterior con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">filtradoEntrada</span> <span class="pre">iifname</span> <span class="pre">enp0s8</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">drop</span></code></p></li>
</ol>
</div>
<div class="section" id="otra-solucion-mas-segura">
<h3>Otra solución (más segura)<a class="headerlink" href="#otra-solucion-mas-segura" title="Enlazar permanentemente con este título">¶</a></h3>
<ol class="arabic">
<li><p>Borramos las reglas con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">flush</span> <span class="pre">ruleset</span></code></p></li>
<li><p>Vamos a crear una tabla con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">table</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span></code></p></li>
<li><p>Ahora creamos una cadena en la que la política por defecto <strong>va a ser mucho más segura</strong>. Usamos el comando <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">chain</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">prohibicionEntrada</span> <span class="pre">{type</span> <span class="pre">filter</span> <span class="pre">hook</span> <span class="pre">input</span> <span class="pre">priority</span> <span class="pre">0\;</span> <span class="pre">policy</span> <span class="pre">drop\;}</span></code></p></li>
<li><p>Ahora todo el tráfico web está prohibido, así que podríamos empezar a dar permiso a quien corresponda.</p>
<blockquote>
<div><ul class="simple">
<li><p>Podríamos dar permiso solo a una cierta IP con el comando <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">prohibicionEntrada</span> <span class="pre">ip</span> <span class="pre">saddr</span> <span class="pre">192.168.100.10</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">accept</span></code></p></li>
<li><p>Podríamos dar permiso a todo el tráfico que entre por una cierta tarjeta con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">prohibicionEntrada</span> <span class="pre">iifname</span> <span class="pre">enp0s3</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">accept</span></code></p></li>
<li><p>Se puede dar permiso a un rango de IPs usando una ip de red con su máscara con <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">nft</span> <span class="pre">add</span> <span class="pre">rule</span> <span class="pre">ip</span> <span class="pre">filtradoWeb</span> <span class="pre">prohibicionEntrada</span> <span class="pre">saddr</span> <span class="pre">192.168.100.0/24</span> <span class="pre">tcp</span> <span class="pre">dport</span> <span class="pre">80</span> <span class="pre">accept</span></code></p></li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
</div>
<div class="section" id="ejercicio-resuelto-con-ficheros">
<h2>Ejercicio resuelto con ficheros<a class="headerlink" href="#ejercicio-resuelto-con-ficheros" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Supongamos que nos han asignado una red como 10.xxx.xxx.xx/8. Se han establecido los requisitos siguientes:</p>
<ul class="simple">
<li><p>Los ordenadores de la oficina (Windows 7 por ejemplo), tienen direcciones como 10.xxx.10.10 con máscara 255.0.0.0.</p></li>
<li><p>Queremos tener un cortafuegos que interconecta dos redes. Por la tarjeta enp0s8 tendremos una dirección como 10.xxx.1.1/8. Por la tarjeta enp0s3 tendremos una dirección como 172.31.xxx.10/16. Esa tarjeta tiene conexión con un router que nos lleva al exterior y cuya IP es 172.31.1.1.</p></li>
<li><p>Teniendo esos datos, es evidente que el Windows 7 llevará como gateway al 10.xxx.1.1 y como DNS pondremos (por ejemplo 8.8.8.8 y 8.8.4.4)</p></li>
</ul>
<div class="section" id="resolucion">
<h3>Resolución<a class="headerlink" href="#resolucion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Empezaremos por asignar los parámetros IP al cortafuegos. Una vez hecho eso deberíamos tener ping al interior de la oficina y al router asignado.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tema_sad/tema_sad.html" class="btn btn-neutral float-right" title="Implantación de soluciones de alta disponibilidad" accesskey="n" rel="next">Siguiente <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../tema_pautas_seguridad_informatica/tema_pautas_seguridad_informatica.html" class="btn btn-neutral float-left" title="Adopción de pautas de seguridad informática" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Anterior</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Oscar GG

    </p>
  </div>
    
    
    
    Construido con <a href="http://sphinx-doc.org/">Sphinx</a> usando un
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">tema</a>
    
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>